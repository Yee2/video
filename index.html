<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="public/video.css">
    <link rel="stylesheet" href="player/progress.css">
    <link rel="stylesheet" href="public/style.css">
</head>
<body>
<!-- 创建一个播放器 -->
<div id="videoPlay" class="yee-player">
    <div class="screen">
        <video id="video">
            <source src="trailer.mp4" id="videoURL">
            Your browser does not support the <code>video</code> element.
        </video>
    </div>
    <div class="film">
        <ul class="menu">
            <li>
                <a onclick="alert('Yee Player v 0.1')">关于播放器</a>
            </li>
        </ul>

    </div>
    <div class="panel" id="panel">
        <div class="play">&#xea1c;</div>
        <div class="progress-bar"></div>
        <div class="full">&#xe98b;</div>
        <div class="sound-bar">
            <div class="gap"><div class="volume-bar"></div></div>
            <div class="sound">&#xea26;</div>
        </div>
        <div class="time">0:0:0/0:0:0</div>
    </div>
</div>
<!-- 构造播放器结束 -->
<div id="list">
</div>
<script src="player/progress.js"></script>
<script type="text/javascript">
    /**
     * @return Element
     * @constructor
     */
    function Q(str) {
        return document.querySelector(str)
    }
    /**
     * @return Element
     */
    Element.prototype.Q = function (selectors) {
        return this.querySelector(selectors);
    };

    /**
     *
     * @param name
     * @param value
     * @returns {string | null}
     * @constructor
     */
    Element.prototype.Data = function (name,value) {
        if (value === undefined){
            return this.getAttribute("data-" + name);
        }else{
            this.setAttribute("data-" + name,value)
        }
    };
    /**
     * @returns EventTarget
     */
    EventTarget.prototype.On = function () {
        this.addEventListener.apply(this,arguments);
        return this;
    };
    (function yeePlayer(ele) {
        if (ele === null) {
            return false;
        }
        ele.style.overflow = "hidden";
        function not(b) {
            return !b;
        }
        function timeFormat(time) {
            time = Math.floor(time)
            var s = time % 60,
                i = Math.floor(time / 60) % 60,
                h = Math.floor(Math.floor(time / 60) / 60);
            if (s < 10) {
                s = '0' + s;
            }
            if (i < 10) {
                i = '0' + i;
            }
            if (h < 10) {
                h = '0' + h;
            }
            if (time < 3600) {
                return i + ":" + s;
            }
            return h + ":" + i + ":" + s;
        }
        let mouseover = false;//鼠标是否在播放器上面
        const video = ele.Q('video'),
            panel = ele.Q('.panel'),
            film = ele.Q('.film'),
            sound = panel.Q('.sound'),
            menu = ele.Q('.menu');
        panel.show = (function () {
            this.style.bottom = "0";
        }).bind(panel);
        panel.hide = (function () {
            this.style.bottom = "-30px";
        }).bind(panel);
        panel.autoHidden = (function () {
            if(panel.timer){
                clearTimeout(panel.timer);
            }
            panel.timer = setTimeout(function () {
                if(not(video.paused)){
                    panel.hide();
                    clearTimeout(panel.timer);
                }
            },2000);
        }).bind(panel);
        panel.timer = null;
        video.On("pause",()=>{
            panel.Q(".play").innerHTML = "&#xea1c;";
            panel.show();
        }).On("playing",()=>{
            panel.autoHidden();
            panel.Q(".play").innerHTML ="&#xea1d;";
        }).On("volumechange",()=> {
            if(video.volume > 0.8){
                panel.Q(".sound").innerHTML = "&#xea26;";
            }else if(video.volume > 0.5){
                panel.Q(".sound").innerHTML = "&#xea27;";
            }else if(video.volume > 0){
                panel.Q(".sound").innerHTML = "&#xea28;";
            }else{
                panel.Q(".sound").innerHTML = "&#xea2a;";
            }
        });

        // 二十一世纪已经过去五分之一了，然而浏览器兼容问题始终作为一个难题困扰着人类。
        document.On("mozfullscreenchange", function( event ) {
            if ( document.mozFullScreenElement ) {
                if (document.mozFullScreenElement !== ele){
                    return;
                }
                // 全屏状态
                panel.Q(".full").innerHTML="&#xe98c;";
            }else{
                panel.Q(".full").innerHTML="&#xe98b;";
            }
        }).On("webkitfullscreenchange",()=>{
            if ( document.webkitFullScreenElement) {
                if (document.webkitFullScreenElement !== ele){
                    return;
                }
                panel.Q(".full").innerHTML="&#xe98c;";
            }else{
                panel.Q(".full").innerHTML="&#xe98b;";
            }
        }).On("fullscreenchange",()=>{
            if ( document.fullScreenElement ) {
                if (document.fullScreenElement !== ele){
                    return;
                }
                panel.Q(".full").innerHTML="&#xe98c;";
            }else{
                panel.Q(".full").innerHTML="&#xe98b;";
            }
        });
        ele.On("click",()=>{
            menu.close();
        });
        var progress = new Progress(".progress-bar");
        progress.onchange = function (v) {
            video.currentTime = video.duration * v;
        };
        progress.init();
        let doc_key_press = function (e) {
            if(e.charCode !== 32){
                return;
            }
            video.trigger();
        };
        ele.On("mouseover",(e)=>{
            mouseover = true;
            document.addEventListener("keypress", doc_key_press );
        }).On("mousemove",(e)=>{
            panel.show();
            panel.autoHidden();
        }).On("mouseout",()=>{
            mouseover = false;
            panel.autoHidden();
            document.removeEventListener("keypress", doc_key_press );
        });

        let volume = new Progress(".volume-bar");
        volume.direction = "v";
        volume.init();
        volume.onchange = (v)=>{
            video.volume = v;
        };

        video.addEventListener('timeupdate', function (e) {
            progress.update(video.currentTime / video.duration);
            panel.querySelector(".time").innerHTML = timeFormat(video.currentTime) + "/" + timeFormat(video.duration);
        });
        (function () {
            var TimeFN = setInterval(function () {
                var l = (video.buffered.end(0) - video.buffered.start(0))/(video.duration - 1);
                progress.buffer(l);
                if(l >= 1){
                    clearInterval(TimeFN);
                }
            },500);
        })();
        menu.show = (function (e) {
            this.style.display = "block";
            this.style.left = e.layerX + "px";
            this.style.top = e.layerY + "px";
        }).bind(menu);
        menu.close = (function (e) {
            this.style.display = "none";
        }).bind(menu);
        video.trigger = (function (e) {
            if (this.paused) {
                this.play();
            } else {
                this.pause();
            }
        }).bind(video);
        menu.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            menu.close(e);
            return false;
        }, false);
        film.addEventListener('contextmenu', function (e) {
            e.preventDefault();
            menu.show(e);
            return false;
        }, false);
        (function () {
            var TimeFn = null;
            film.addEventListener('click', function (e) {
                clearTimeout(TimeFn);
                TimeFn = setTimeout(function () {
                    menu.close(e);
                    video.trigger(e);
                }, 300);
                e.preventDefault();
                return false;
            }, false);
            film.addEventListener('dblclick', function (e) {
                e.preventDefault();
                clearTimeout(TimeFn);
                panel.querySelector(".full").dispatchEvent(new Event("click"));
                return false;
            }, false);
        })();
        panel.addEventListener('selectstart', function (ev) {
            ev.preventDefault();
            return false;
        }, false);
        panel.Q(".play").On("click", function () {
            video.trigger();
        });
        panel.Q(".full").On("click", function () {
            var fullscreenElement = document.fullscreenElement ||
                document.mozFullScreenElement ||
                document.webkitFullscreenElement;
            if (fullscreenElement) {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                return;
            }
            if (ele.requestFullScreen) {
                ele.requestFullScreen();
                return;
            }
            if (ele.webkitRequestFullScreen) {
                ele.webkitRequestFullScreen();
                return;
            }
            if (ele.mozRequestFullScreen) {
                ele.mozRequestFullScreen();
                return;
            }
            console.log("浏览器不支持");
        });
        panel.Q(".sound").On("click", function () {
        });

    })(document.querySelector("#videoPlay"));

</script>

</body>
</html>
